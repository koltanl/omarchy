#!/bin/bash

# Workspace navigation script with looping behavior
# Usage: workspace-nav [left|right] [--move-window]
# Cap at workspace 5 with looping behavior
# --move-window: Move the active window along with workspace change

# Hardcoded workspace mapping: 1-3 maps to 4-6
MAX_WORKSPACE=6
MIN_WORKSPACE=4
MOVE_WINDOW=false

# Function to map workspace 1-3 to 4-6
map_workspace() {
    local ws=$1
    if [ "$ws" -ge 1 ] && [ "$ws" -le 3 ]; then
        echo $((ws + 3))
    else
        echo "$ws"
    fi
}

# Function to get current workspace (mapped to 4-6 range)
get_current_workspace() {
    local current=$(hyprctl activeworkspace -j | jq -r '.id')
    map_workspace "$current"
}

# Parse arguments
if [ "$2" = "--move-window" ]; then
    MOVE_WINDOW=true
fi

# Add +3 modifier for out-of-the-box functionality
if [ "$1" = "+3" ]; then
    # Get current workspace (mapped to 4-6 range)
    CURRENT_WS=$(get_current_workspace)
    NEW_WS=$((CURRENT_WS + 3))
    
    # Cap at MAX_WORKSPACE with looping (4-6 range)
    if [ "$NEW_WS" -gt "$MAX_WORKSPACE" ]; then
        NEW_WS=$((NEW_WS - 3))  # Loop back within 4-6 range
    fi
    
    # Move active window if requested
    if [ "$MOVE_WINDOW" = true ]; then
        # Get the active window address
        ACTIVE_WINDOW=$(hyprctl activewindow -j | jq -r '.address')
        
        # Only move if there's an active window (not empty workspace)
        if [ "$ACTIVE_WINDOW" != "null" ] && [ -n "$ACTIVE_WINDOW" ]; then
            # Move the window to the new workspace and follow it
            hyprctl dispatch movetoworkspace "$NEW_WS,address:$ACTIVE_WINDOW"
        else
            # No active window, just switch workspace
            hyprctl dispatch workspace "$NEW_WS"
        fi
    else
        # Switch to the new workspace
        hyprctl dispatch workspace "$NEW_WS"
    fi
    exit 0
fi

# Add -3 modifier for going back 3 workspaces
if [ "$1" = "-3" ]; then
    # Get current workspace (mapped to 4-6 range)
    CURRENT_WS=$(get_current_workspace)
    NEW_WS=$((CURRENT_WS - 3))
    
    # Handle wrapping around (if we go below 4, loop to 6)
    if [ "$NEW_WS" -lt "$MIN_WORKSPACE" ]; then
        NEW_WS=$((MAX_WORKSPACE + NEW_WS - MIN_WORKSPACE + 1))  # Loop within 4-6 range
    fi
    
    # Move active window if requested
    if [ "$MOVE_WINDOW" = true ]; then
        # Get the active window address
        ACTIVE_WINDOW=$(hyprctl activewindow -j | jq -r '.address')
        
        # Only move if there's an active window (not empty workspace)
        if [ "$ACTIVE_WINDOW" != "null" ] && [ -n "$ACTIVE_WINDOW" ]; then
            # Move the window to the new workspace and follow it
            hyprctl dispatch movetoworkspace "$NEW_WS,address:$ACTIVE_WINDOW"
        else
            # No active window, just switch workspace
            hyprctl dispatch workspace "$NEW_WS"
        fi
    else
        # Switch to the new workspace
        hyprctl dispatch workspace "$NEW_WS"
    fi
    exit 0
fi

# Get current workspace (mapped to 4-6 range)
CURRENT_WS=$(get_current_workspace)

if [ "$1" = "left" ]; then
    # Move to previous workspace with looping (4-6 range)
    if [ "$CURRENT_WS" -le "$MIN_WORKSPACE" ]; then
        NEW_WS=$MAX_WORKSPACE
    else
        NEW_WS=$((CURRENT_WS - 1))
    fi
elif [ "$1" = "right" ]; then
    # Move to next workspace with looping (4-6 range)
    if [ "$CURRENT_WS" -ge "$MAX_WORKSPACE" ]; then
        NEW_WS=$MIN_WORKSPACE
    else
        NEW_WS=$((CURRENT_WS + 1))
    fi
else
    echo "Usage: $0 [left|right|+3|-3] [--move-window]"
    exit 1
fi

# Move active window if requested
if [ "$MOVE_WINDOW" = true ]; then
    # Get the active window address
    ACTIVE_WINDOW=$(hyprctl activewindow -j | jq -r '.address')
    
    # Only move if there's an active window (not empty workspace)
    if [ "$ACTIVE_WINDOW" != "null" ] && [ -n "$ACTIVE_WINDOW" ]; then
        # Move the window to the new workspace
        hyprctl dispatch movetoworkspace "$NEW_WS,address:$ACTIVE_WINDOW"
    else
        # No active window, just switch workspace
        hyprctl dispatch workspace "$NEW_WS"
    fi
else
    # Switch to the new workspace without moving window
    hyprctl dispatch workspace "$NEW_WS"
fi